{% extends 'layout/base.html' %}
{% block title %}Question Bank | Evaluated Answers{% endblock title %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-center">My Evaluated & Pending Responses</h2>

    {% if grouped_responses %}
        <ul class="list-group">
            {% for topic, responses in grouped_responses.items %}
                <li class="list-group-item">
                    <!-- Topic Header -->
                    <a class="d-flex justify-content-between align-items-center"
                       data-toggle="collapse"
                       href="#collapseTopic{{ forloop.counter }}"
                       role="button"
                       aria-expanded="false"
                       aria-controls="collapseTopic{{ forloop.counter }}">
                        <div>
                            <strong>{{ topic }}</strong><br>
                            <small class="text-muted">{{ responses|length }} submission{{ responses|length|pluralize }}</small>
                        </div>
                        <span class="text-primary">View</span>
                    </a>

                    <!-- Responses List -->
                    <div class="collapse mt-3" id="collapseTopic{{ forloop.counter }}">
                        <ul class="list-group">
                            {% for response in responses %}
                                <li class="list-group-item">
                                    <p class="mb-1"><strong>Answer:</strong> {{ response.answer|truncatewords:25 }}</p>
                                    <p class="mb-1">
                                        <strong>Status:</strong>
                                        {% if response.evaluated %}
                                            <span class="text-success">Evaluated</span> |
                                            <strong>Marks:</strong> {{ response.marks }}/{{ response.question.marks }} |
                                            <small class="text-muted">{{ response.evaluated_at|date:"M d, Y @ H:i" }}</small>
                                        {% else %}
                                            <span class="text-danger">Pending Evaluation</span>
                                        {% endif %}
                                    </p>

                                    {% if response.evaluated and response.evaluation_feedback %}
                                        <p>
                                            <a class="btn btn-sm btn-outline-secondary"
                                               data-toggle="collapse"
                                               href="#feedback{{ response.id }}"
                                               role="button"
                                               aria-expanded="false"
                                               aria-controls="feedback{{ response.id }}">
                                                Show Feedback
                                            </a>
                                        </p>
                                        <div class="collapse" id="feedback{{ response.id }}">
                                            <div class="card card-body small">
                                                <pre class="mb-0">{{ response.evaluation_feedback }}</pre>
                                            </div>
                                        </div>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </li>
            {% endfor %}
        </ul>

        <!-- Total Score -->
        <div class="mt-4 text-right">
            <strong>Total Score:</strong>
            <span class="badge badge-success p-2">
                {{ total_marks }}/{{ max_possible_marks }}
            </span>
        </div>
    {% else %}
        <div class="alert alert-info text-center">
            No evaluated or pending responses found for <strong>{{ request.user.username }}</strong>.
        </div>
    {% endif %}
</div>
{% endblock %}
